<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: sans-serif;
      padding: 16px;
    }
    #select, #progress, #done {
      display: none;
    }
    button {
      padding: 8px 14px;
      margin-top: 12px;
    }
    .errorline {
      white-space: pre-wrap;
      margin-bottom: 8px;
      color: #b00;
    }
  </style>
</head>
<body>

  <!-- Section-Auswahl -->
  <div id="select">
    <h2>Section auswÃ¤hlen</h2>
    <p>Bitte eine Section wÃ¤hlen:</p>
    <select id="sectionSelect" size="6" style="width:100%"></select>
    <button id="run">Plugin starten</button>
  </div>

  <!-- Fortschritt -->
  <div id="progress">
    <h2>Bitte wartenâ€¦</h2>
    <p>Das Plugin arbeitet.</p>
  </div>

  <!-- Fehlerprotokoll -->
  <div id="done">
    <h2>Fehler-Protokoll</h2>
    <div id="errcontainer"></div>
    <button id="close">SchlieÃŸen</button>
  </div>

<script>
  const $ = (s) => document.querySelector(s);

  onmessage = (ev) => {
    const msg = ev.data.pluginMessage;

    if (msg.type === "init") {
      $("#select").style.display = "block";
      $("#progress").style.display = "none";
      $("#done").style.display = "none";

      const sel = $("#sectionSelect");
      sel.innerHTML = "";
      msg.sections.forEach(sec => {
        const opt = document.createElement("option");
        opt.value = sec.id;
        opt.textContent = sec.name;
        sel.appendChild(opt);
      });
    }

    if (msg.type === "progress") {
      $("#select").style.display = "none";
      $("#progress").style.display = "block";
      $("#done").style.display = "none";
    }

    if (msg.type === "done") {
      $("#select").style.display = "none";
      $("#progress").style.display = "none";
      $("#done").style.display = "block";

      const cont = $("#errcontainer");
      cont.innerHTML = "";

      if (msg.errors.length === 0) {
        cont.innerHTML = "<p>Keine Fehler ðŸŽ‰</p>";
      } else {
        msg.errors.forEach(err => {
          const d = document.createElement("div");
          d.className = "errorline";
          d.textContent = err;
          cont.appendChild(d);
        });
      }
    }
  };

  $("#run").onclick = () => {
    const ids = Array.from($("#sectionSelect").selectedOptions).map(o => o.value);
    parent.postMessage({ pluginMessage: { type: "run-plugin", selectedSectionIds: ids } }, "*");
  };

  $("#close").onclick = () => {
    parent.postMessage({ pluginMessage: { type: "close-error-window" } }, "*");
  };
</script>

</body>
</html>